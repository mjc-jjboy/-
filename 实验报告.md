# TOA中Caffery与Chan算法的实现

---

## Caffery方法

```python
def caffery_toa_localization(anchors, distances):
    """
    anchors: N×2 array, anchor positions
    distances: N array, measured distances (TOA*c)
    """
    a1 = anchors[0]
    d1 = distances[0]
    A, b = [], []
    for i in range(1, len(anchors)):
        xi, yi = anchors[i]
        x1, y1 = a1
        di = distances[i]
        row = [2*(xi-x1), 2*(yi-y1)]
        rhs = (xi**2 - x1**2) + (yi**2 - y1**2) + (d1**2 - di**2)
        A.append(row)
        b.append(rhs)
    A = np.array(A)
    b = np.array(b)
    # 最小二乘解
    sol, *_ = np.linalg.lstsq(A, b, rcond=None)
    return sol
```


1. 以第一个锚点作为参考点 (`a1 = anchors[0]`)

    2.对于每个其他锚点，构建线性方程组：

* 左边系数矩阵A：包含与参考点的坐标差的2倍
* 右边常数项b：包含坐标平方差和距离平方差的组合

   3.使用最小二乘法求解这个超定线性方程组，得到目标位置的估计值

数学推导：

(x - x₁)² + (y - y₁)² = d₁²
(x - xᵢ)² + (y - yᵢ)² = dᵢ²

两方程相减：

2(xᵢ - x₁)x + 2(yᵢ - y₁)y = (xᵢ² - x₁²) + (yᵢ² - y₁²) + (d₁² - dᵢ²)

## Chan方法

```python
def chan_toa_localization(anchors, distances, noise_var=1.0):
    """
    Chan TOA localization in 2D
    anchors: N×2 array
    distances: N array (measured distances)
    noise_var: measurement noise variance
    """
    N = len(anchors)
    x1, y1 = anchors[0]
    d1 = distances[0]

    A, b = [], []
    for i in range(1, N):
        xi, yi = anchors[i]
        di = distances[i]
        row = [x1 - xi, y1 - yi]
        rhs = 0.5 * ((x1**2 + y1**2 - d1**2) - (xi**2 + yi**2 - di**2))
        A.append(row)
        b.append(rhs)
    A = np.array(A)
    b = np.array(b)

    # 权重矩阵（这里简单用 I，也可根据噪声方差设置 diag(d_i^2)）
    W = np.eye(len(b)) / noise_var

    # 加权最小二乘解
    est, *_ = np.linalg.lstsq(W @ A, W @ b, rcond=None)
    return est
```

以第一个锚点为参考点，提取其坐标(x₁,y₁)和距离d₁

构建线性方程组：对每个后续锚点(i)，通过将其与参考锚点的距离方程相减，消去二次项，得到线性方程

形成系数矩阵A和右侧向量b：

* 矩阵A的每行包含(x₁-xᵢ, y₁-yᵢ)
* 向量b的每个元素为0.5×[(x₁²+y₁²-d₁²)-(xᵢ²+yᵢ²-dᵢ²)]

构造权重矩阵W：使用单位矩阵除以噪声方差

应用加权最小二乘法求解线性方程组，得到目标位置估计

数学基础：

将原本非线性的距离方程转换为线性方程组。假设目标位置为(x,y)，则对于每个锚点(i)，有距离方程：(x-xᵢ)² + (y-yᵢ)² = dᵢ²。通过与参考锚点方程相减，消去二次项，得到关于x和y的线性方程。
